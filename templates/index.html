<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMARC Reports</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .pagination {
            margin: 20px 0;
            text-align: center;
        }
        .pagination button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #f2f2f2;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>DMARC Reports</h1>
    <div>
        <img src="data:image/png;base64,{{ plot_url }}" alt="DMARC Reports Chart">
    </div>

    <!-- Statystyki za ostatni tydzień -->
    <div id="stats-current">
        <h2>Statystyki za ostatni tydzień</h2>
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Delivered %</th>
                    <th>Rejected %</th>
                    <th>Total Count</th>
                    <th>Delivered Count</th>
                    <th>Rejected Count</th>
                </tr>
            </thead>
            <tbody>
            {% for domain, stat in stats_week.items() %}
                <tr>
                    <td>{{ domain }}</td>
                    <td>{{ stat['delivered_percentage'] }}%</td>
                    <td>{{ stat['rejected_percentage'] }}%</td>
                    <td>{{ stat['total_count'] }}</td>
                    <td>{{ stat['delivered_count'] }}</td>
                    <td>{{ stat['rejected_count'] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- Statystyki za ostatni miesiąc -->
        <h2>Statystyki za ostatni miesiąc</h2>
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Delivered %</th>
                    <th>Rejected %</th>
                    <th>Total Count</th>
                    <th>Delivered Count</th>
                    <th>Rejected Count</th>
                </tr>
            </thead>
            <tbody>
            {% for domain, stat in stats_month.items() %}
                <tr>
                    <td>{{ domain }}</td>
                    <td>{{ stat['delivered_percentage'] }}%</td>
                    <td>{{ stat['rejected_percentage'] }}%</td>
                    <td>{{ stat['total_count'] }}</td>
                    <td>{{ stat['delivered_count'] }}</td>
                    <td>{{ stat['rejected_count'] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Statystyki całościowe (All Time) -->
    <div id="stats-all">
        <h2>Statystyki całościowe (All Time)</h2>
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Delivered %</th>
                    <th>Rejected %</th>
                    <th>Total Count</th>
                    <th>Delivered Count</th>
                    <th>Rejected Count</th>
                </tr>
            </thead>
            <tbody>
            {% for domain, stat in stats_all.items() %}
                <tr>
                    <td>{{ domain }}</td>
                    <td>{{ stat['delivered_percentage'] }}%</td>
                    <td>{{ stat['rejected_percentage'] }}%</td>
                    <td>{{ stat['total_count'] }}</td>
                    <td>{{ stat['delivered_count'] }}</td>
                    <td>{{ stat['rejected_count'] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Główna tabela z raportami (paginacja i filtry) -->
    <div id="table-container">
        <h2>Główna tabela z raportami</h2>
        <table id="reports-table" class="data">
            <thead>
                <tr>
                    <th><input class="filter-input" data-column="LP" placeholder="Filter LP"></th>
                    <th><input class="filter-input" data-column="org_name" placeholder="Filter org_name"></th>
                    <th><input class="filter-input" data-column="email" placeholder="Filter email"></th>
                    <th><input class="filter-input" data-column="report_id" placeholder="Filter report_id"></th>
                    <th><input class="filter-input" data-column="date_begin" placeholder="Filter date_begin"></th>
                    <th><input class="filter-input" data-column="date_end" placeholder="Filter date_end"></th>
                    <th><input class="filter-input" data-column="source_ip" placeholder="Filter source_ip"></th>
                    <th><input class="filter-input" data-column="count" placeholder="Filter count"></th>
                    <th><input class="filter-input" data-column="disposition" placeholder="Filter disposition"></th>
                    <th><input class="filter-input" data-column="dkim" placeholder="Filter dkim"></th>
                    <th><input class="filter-input" data-column="spf" placeholder="Filter spf"></th>
                    <th><input class="filter-input" data-column="envelope_to" placeholder="Filter envelope_to"></th>
                    <th><input class="filter-input" data-column="envelope_from" placeholder="Filter envelope_from"></th>
                    <th><input class="filter-input" data-column="header_from" placeholder="Filter header_from"></th>
                    <th><input class="filter-input" data-column="dkim_domain" placeholder="Filter dkim_domain"></th>
                    <th><input class="filter-input" data-column="dkim_selector" placeholder="Filter dkim_selector"></th>
                    <th><input class="filter-input" data-column="dkim_result" placeholder="Filter dkim_result"></th>
                    <th><input class="filter-input" data-column="spf_domain" placeholder="Filter spf_domain"></th>
                    <th><input class="filter-input" data-column="spf_scope" placeholder="Filter spf_scope"></th>
                    <th><input class="filter-input" data-column="spf_result" placeholder="Filter spf_result"></th>
                </tr>
                <tr>
                    <th>LP</th>
                    <th>org_name</th>
                    <th>email</th>
                    <th>report_id</th>
                    <th>date_begin</th>
                    <th>date_end</th>
                    <th>source_ip</th>
                    <th>count</th>
                    <th>disposition</th>
                    <th>dkim</th>
                    <th>spf</th>
                    <th>envelope_to</th>
                    <th>envelope_from</th>
                    <th>header_from</th>
                    <th>dkim_domain</th>
                    <th>dkim_selector</th>
                    <th>dkim_result</th>
                    <th>spf_domain</th>
                    <th>spf_scope</th>
                    <th>spf_result</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <button id="prev-page">Previous</button>
        <button id="next-page">Next</button>
    </div>
    <script>
        let offset = 0;
        const limit = 10;
        const filters = {};

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function loadData() {
            const filterParams = Object.keys(filters).map(key => `${key}=${filters[key]}`).join('&');
            const url = `/api/data?offset=${offset}&limit=${limit}&${filterParams}`;
            $.getJSON(url, function(data) {
                const tbody = $("#reports-table tbody");
                tbody.empty();
                data.forEach(row => {
                    const tr = $("<tr></tr>");
                    Object.keys(row).forEach(key => {
                        let cellValue = row[key];
                        if (key === 'date_begin' || key === 'date_end') {
                            cellValue = formatDate(cellValue);
                        }
                        tr.append($("<td></td>").text(cellValue));
                    });
                    tbody.append(tr);
                });
            });
        }

        $(".filter-input").on("input", function() {
            const column = $(this).data("column");
            const value = $(this).val();
            if (value) {
                filters[column] = value;
            } else {
                delete filters[column];
            }
            offset = 0; // Reset offset when filtering
            loadData();
        });

        $("#prev-page").click(function() {
            if (offset > 0) {
                offset -= limit;
                loadData();
            }
        });

        $("#next-page").click(function() {
            offset += limit;
            loadData();
        });

        $(document).ready(function() {
            loadData();
        });
    </script>
</body>
</html>
